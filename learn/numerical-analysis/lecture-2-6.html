<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture 2-6: Solving ODEs üåä</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ntu: {
                            red: '#e11d48',
                            blue: '#1e3a8a',
                            light: '#eff6ff',
                            accent: '#f59e0b',
                        }
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'sans-serif'],
                        mono: ['Consolas', 'Monaco', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .slide-card {
            background: white;
            border-radius: 12px;
            padding: 2.5rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        /* Editor & Output Styles */
        .editor-container {
            position: relative;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #ffffff;
            margin-bottom: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .editor-wrapper {
            position: relative;
            min-height: 250px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            background-color: #ffffff;
        }

        .editor-wrapper textarea,
        .editor-wrapper pre {
            margin: 0;
            padding: 1rem;
            border: none;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            white-space: pre;
            overflow: auto;
            position: absolute;
            top: 0;
            left: 0;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            tab-size: 4;
        }

        .editor-wrapper textarea {
            z-index: 2;
            color: transparent;
            background: transparent;
            caret-color: #000;
            resize: none;
            outline: none;
        }

        .editor-wrapper pre {
            z-index: 1;
            background: transparent;
            pointer-events: none;
        }

        .run-bar {
            background: #f1f5f9;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .run-btn {
            background: #1e3a8a;
            color: white;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .run-btn:hover {
            background: #1e40af;
        }

        .run-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .output-box {
            margin-top: 0.5rem;
            background: #ffffff;
            color: #334155;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            min-height: 100px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .output-img {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #e2e8f0;
        }

        .math-box {
            background: #eff6ff;
            border-left: 4px solid #1e3a8a;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 4px 4px 0;
            overflow-x: auto;
        }

        /* Teach Mode Styles */
        body.teach-mode {
            overflow: hidden;
            background: black;
        }

        body.teach-mode nav,
        body.teach-mode header,
        body.teach-mode footer {
            display: none !important;
        }

        body.teach-mode main {
            max-width: none;
            padding: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.teach-mode .slide-card {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 0;
            padding: 4rem;
            z-index: 100;
            overflow-y: auto;
            align-content: center;
        }

        body.teach-mode .slide-card.active-slide {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .teach-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e11d48;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(225, 29, 72, 0.4);
            cursor: pointer;
            z-index: 9999;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .teach-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(225, 29, 72, 0.5);
        }

        body.teach-mode .teach-btn {
            display: none;
        }
    </style>
</head>

<body class="antialiased">

    <button onclick="toggleTeachMode()" class="teach-btn">
        <span>üë®‚Äçüè´</span> Teach Mode
    </button>

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <span class="font-bold text-xl text-slate-800">Numerical Analysis <span
                    class="text-ntu-blue">2-6</span></span>
            <div class="hidden md:flex space-x-1 text-sm font-medium text-slate-600">
                <a href="#intro" class="px-3 py-1 hover:bg-gray-100 rounded">Intro</a>
                <a href="#euler" class="px-3 py-1 hover:bg-gray-100 rounded">Euler</a>
                <a href="#rk" class="px-3 py-1 hover:bg-gray-100 rounded">Runge-Kutta</a>
                <a href="#pendulum" class="px-3 py-1 hover:bg-gray-100 rounded">Pendulum</a>
                <a href="#springs" class="px-3 py-1 hover:bg-gray-100 rounded">Springs</a>
            </div>
        </div>
    </nav>

    <header class="pt-24 pb-16 text-center px-4 bg-gradient-to-b from-blue-50 to-transparent">
        <h1 class="text-5xl md:text-6xl font-extrabold text-slate-900 mb-6 tracking-tight">
            Solving ODEs üåä
        </h1>
        <p class="text-xl text-slate-600 max-w-2xl mx-auto mb-8">
            From Newton's falling apple to chaotic double springs. <br>
            <span class="text-sm text-blue-600 font-mono">dy/dt = f(y,t)</span>
        </p>
        <div class="flex justify-center gap-4 text-sm text-gray-500 font-mono">
            <span>Lecture 2-6</span>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 pb-20">

        <section id="intro" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">1. The Work of "Physicists" üçé</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 1-3</span>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <p class="mb-4 text-lg">Solving differential equations is the bread and butter of classical
                        mechanics.</p>
                    <ul class="space-y-2 text-slate-600 list-disc ml-5">
                        <li>Many equations in nature <strong>cannot</strong> be solved analytically.</li>
                        <li>Numerical approximations are often <strong>good enough</strong>.</li>
                        <li>Today: Euler, Runge-Kutta, and Animations!</li>
                    </ul>
                </div>
                <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-6xl mb-2">üçè</div>
                        <div class="font-serif italic text-xl text-slate-700">"Let's get back to F=ma!"</div>
                    </div>
                </div>
            </div>
        </section>

        <section id="euler" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">2. Euler's Method</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slide 4-6</span>
            </div>

            <p class="mb-4 text-slate-600">Let's solve $\frac{dy}{dt} = y$ with $y(0)=1$. We know the answer is $e^t$.
            </p>

            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                <h3 class="font-bold text-yellow-800 mb-2">Algorithm</h3>
                <div class="math-box text-sm bg-white">
                    $$ y_{n+1} \approx y_n + h \cdot f(y_n, t_n) $$
                </div>
                <p class="text-xs text-yellow-700">Precision: $O(h)$ (Not very good)</p>
            </div>

            <div id="code-01"></div>
        </section>

        <section id="rk" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">3. The Runge-Kutta Family üöÄ</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 7-15</span>
            </div>

            <div class="mb-12">
                <h3 class="text-xl font-bold text-slate-800 mb-2">RK2 (2nd Order)</h3>
                <p class="text-sm text-slate-600 mb-2">Predictor-Corrector approach. Much better than Euler.</p>
                <div id="code-02"></div>
            </div>

            <div class="mb-12">
                <h3 class="text-xl font-bold text-slate-800 mb-2">RK4 (4th Order)</h3>
                <p class="text-sm text-slate-600 mb-2">The standard workhorse. Very precise ($O(h^5)$ local error).</p>
                <div id="code-03"></div>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-bold text-slate-800 mb-2">RK45 (Adaptive Step Size)</h3>
                <p class="text-sm text-slate-600 mb-2">Automatically adjusts step size $h$ to maintain precision.</p>
                <div id="code-04"></div>
            </div>
        </section>

        <section id="pendulum" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">4. Physics: The Pendulum üï∞Ô∏è</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 16-25</span>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div>
                    <div class="math-box text-sm">
                        $$ \frac{d^2\theta}{dt^2} = -\frac{g}{R}\sin(\theta) $$
                        1. $\dot{\theta} = \omega$ <br>
                        2. $\dot{\omega} = -\frac{g}{R}\sin(\theta)$
                    </div>
                    <p class="text-sm text-slate-600 mb-4">
                        Euler fails to conserve energy. RK4 keeps it stable.
                    </p>
                    <div id="code-07"></div>
                </div>

                <div
                    class="relative bg-slate-900 rounded-xl overflow-hidden shadow-lg h-64 flex items-center justify-center">
                    <canvas id="pendulumCanvas" width="400" height="250"></canvas>
                    <div class="absolute top-2 left-2 text-xs font-mono text-green-400 bg-black/50 p-2 rounded">
                        Method: RK4<br>
                        Energy: <span id="pendE">0.00</span>
                    </div>
                    <button onclick="togglePendulum()"
                        class="absolute bottom-2 right-2 bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded shadow">
                        Play/Pause
                    </button>
                </div>
            </div>

            <div class="mt-8">
                <h4 class="font-bold text-slate-800 mb-2">Animation Code Logic (SciPy Version)</h4>
                <div id="code-08a"></div>
            </div>
        </section>

        <section id="scipy" class="slide-card border-l-4 border-ntu-blue">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">5. Using SciPy `solve_ivp`</h2>
            <p class="mb-4 text-slate-600">Why write your own solver? Use industrial strength tools.</p>
            <div id="code-08"></div>
        </section>

        <section id="springs" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">6. Springs & Chaos üåÄ</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 30+</span>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div
                    class="relative bg-black rounded-xl overflow-hidden shadow-lg h-64 flex items-center justify-center border border-gray-700">
                    <canvas id="springCanvas" width="400" height="250"></canvas>
                    <div class="absolute top-2 left-2 text-xs font-mono text-orange-400 bg-black/50 p-2 rounded">
                        2D Spring<br>
                        Energy: <span id="springE">0.00</span>
                    </div>
                    <button onclick="toggleSpring()"
                        class="absolute bottom-2 right-2 bg-orange-600 hover:bg-orange-500 text-white text-xs px-3 py-1 rounded shadow">
                        Play/Pause
                    </button>
                </div>

                <div>
                    <h4 class="font-bold text-slate-800 mb-2">System Equations</h4>
                    <p class="text-sm text-slate-600 mb-2">Hooke's Law + Gravity in 2D.</p>
                    <div id="code-09"></div>
                </div>
            </div>

            <div class="mt-8">
                <h3 class="font-bold text-slate-700 mb-2">Double Spring (Coupled System)</h3>
                <div id="code-09a"></div>
            </div>

        </section>

        <section id="hands-on" class="slide-card bg-gradient-to-br from-indigo-50 to-purple-50 border-indigo-100">
            <h2 class="text-2xl font-bold text-indigo-900 mb-6 flex items-center gap-3">
                <span>üëê</span> Hands-On Session
            </h2>
            <p class="text-slate-600 mb-4">Try simulating these scenarios:</p>
            <ul class="list-disc ml-5 text-sm text-slate-600">
                <li><strong>Gravity Shot:</strong> $a = 1/r^2$. Can you orbit a black hole?</li>
                <li><strong>Damped Oscillator:</strong> Add friction $f = -bv$.</li>
            </ul>
        </section>

    </main>

    <footer class="bg-white border-t py-12 text-center text-sm text-gray-400 mt-12">
        <p>Numerical Analysis Lecture 2-6</p>
    </footer>

    <script>
        // --- Teach Mode Logic (Preserved) ---
        let isTeachMode = false;
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide-card');

        function toggleTeachMode() {
            isTeachMode = !isTeachMode;
            document.body.classList.toggle('teach-mode');

            if (isTeachMode) {
                updateCurrentSlideFromScroll();
                enterFullscreen();
                showSlide(currentSlide);
            } else {
                exitFullscreen();
                slides[currentSlide].scrollIntoView({ behavior: 'auto', block: 'start' });
            }
        }

        function enterFullscreen() {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        }

        function exitFullscreen() {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }

        function showSlide(index) {
            slides.forEach((slide, i) => {
                slide.classList.toggle('active-slide', i === index);
            });
        }

        function nextSlide() {
            if (currentSlide < slides.length - 1) {
                currentSlide++;
                showSlide(currentSlide);
            }
        }

        function prevSlide() {
            if (currentSlide > 0) {
                currentSlide--;
                showSlide(currentSlide);
            }
        }

        function updateCurrentSlideFromScroll() {
            let closestIndex = 0;
            let minDistance = Infinity;
            slides.forEach((slide, i) => {
                const rect = slide.getBoundingClientRect();
                const distance = Math.abs(rect.top);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestIndex = i;
                }
            });
            currentSlide = closestIndex;
        }

        document.addEventListener('keydown', (e) => {
            if (!isTeachMode) return;
            if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'ArrowDown') nextSlide();
            else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') prevSlide();
            else if (e.key === 'Escape') {
                if (isTeachMode) toggleTeachMode();
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && isTeachMode) toggleTeachMode();
        });


        // --- PENDULUM CANVAS LOGIC ---
        let pId = null;
        let pState = { th: Math.PI * 0.9, om: 0 };
        const pParams = { g: 9.8, R: 1, dt: 0.02 };

        function drawPendulum(ctx, w, h) {
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, w, h);
            const cx = w / 2, cy = h / 3;
            const scale = 100;
            const bx = cx + scale * Math.sin(pState.th);
            const by = cy + scale * Math.cos(pState.th);

            ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(bx, by);
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();

            ctx.beginPath(); ctx.arc(bx, by, 8, 0, 2 * Math.PI);
            ctx.fillStyle = '#ef4444'; ctx.fill();
        }

        function updatePendulum() {
            const { th, om } = pState;
            const { g, R, dt } = pParams;
            const f = (t, o) => -g / R * Math.sin(t);
            const k1t = om; const k1o = f(th, om);
            const k2t = om + 0.5 * dt * k1o; const k2o = f(th + 0.5 * dt * k1t, om + 0.5 * dt * k1o);
            const k3t = om + 0.5 * dt * k2o; const k3o = f(th + 0.5 * dt * k2t, om + 0.5 * dt * k2o);
            const k4t = om + dt * k3o; const k4o = f(th + dt * k3t, om + dt * k3o);
            pState.th += dt / 6 * (k1t + 2 * k2t + 2 * k3t + k4t);
            pState.om += dt / 6 * (k1o + 2 * k2o + 2 * k3o + k4o);
            const E = 1 * g * (1 - Math.cos(pState.th)) + 0.5 * (R * pState.om) ** 2;
            document.getElementById('pendE').innerText = E.toFixed(4);
        }

        function togglePendulum() {
            if (pId) { cancelAnimationFrame(pId); pId = null; }
            else {
                const cvs = document.getElementById('pendulumCanvas');
                const ctx = cvs.getContext('2d');
                function loop() { updatePendulum(); drawPendulum(ctx, cvs.width, cvs.height); pId = requestAnimationFrame(loop); }
                loop();
            }
        }
        // Initialize
        setTimeout(() => drawPendulum(document.getElementById('pendulumCanvas').getContext('2d'), 400, 250), 1000);

        // --- SPRING CANVAS LOGIC ---
        let sId = null;
        let sState = { x: 0.3, y: 0.4, vx: 0, vy: 0 };
        const sParams = { k: 50, m: 1, g: 9.8, R0: 0.5, dt: 0.015 };

        function drawSpring(ctx, w, h) {
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, w, h);
            const cx = w / 2, cy = 20;
            const scale = 200;
            const bx = cx + sState.x * scale;
            const by = cy + sState.y * scale;

            ctx.beginPath(); ctx.moveTo(cx, cy);
            const segs = 12;
            for (let i = 1; i <= segs; i++) {
                const r = i / segs;
                const zig = (i % 2 == 0 ? 6 : -6) * (1 - r);
                ctx.lineTo(cx + (bx - cx) * r + zig, cy + (by - cy) * r);
            }
            ctx.strokeStyle = 'orange'; ctx.lineWidth = 2; ctx.stroke();
            ctx.beginPath(); ctx.arc(bx, by, 8, 0, 2 * Math.PI);
            ctx.fillStyle = 'red'; ctx.fill();
        }

        function updateSpring() {
            const { x, y, vx, vy } = sState;
            const { k, m, g, R0, dt } = sParams;
            const getAcc = (px, py) => {
                const R = Math.sqrt(px ** 2 + py ** 2);
                const fs = -k * (R - R0);
                return [(fs * px / R) / m, (fs * py / R) / m + g];
            }
            const [ax1, ay1] = getAcc(x, y);
            const x2 = x + 0.5 * dt * vx;
            const y2 = y + 0.5 * dt * vy;
            const vx2 = vx + 0.5 * dt * ax1;
            const vy2 = vy + 0.5 * dt * ay1;
            const [ax2, ay2] = getAcc(x2, y2);
            sState.x += dt * vx2;
            sState.y += dt * vy2;
            sState.vx += dt * ax2;
            sState.vy += dt * ay2;
            const R = Math.sqrt(sState.x ** 2 + sState.y ** 2);
            const E = 0.5 * k * (R - R0) ** 2 + 0.5 * m * (sState.vx ** 2 + sState.vy ** 2) - m * g * sState.y;
            document.getElementById('springE').innerText = E.toFixed(2);
        }

        function toggleSpring() {
            if (sId) { cancelAnimationFrame(sId); sId = null; }
            else {
                const cvs = document.getElementById('springCanvas');
                const ctx = cvs.getContext('2d');
                function loop() { updateSpring(); drawSpring(ctx, cvs.width, cvs.height); sId = requestAnimationFrame(loop); }
                loop();
            }
        }
        // Initialize
        setTimeout(() => drawSpring(document.getElementById('springCanvas').getContext('2d'), 400, 250), 1000);


        // --- Pyodide Setup ---
        let pyodide = null;
        async function initPyodideEnvironment() {
            if (pyodide) return pyodide;
            pyodide = await loadPyodide();
            await pyodide.loadPackage(['numpy', 'matplotlib', 'scipy']);
            return pyodide;
        }

        async function runPythonCode(code) {
            await initPyodideEnvironment();
            const setupCode = `
import sys
import io
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
plt.close('all')
sys.stdout = io.StringIO()
sys.stderr = io.StringIO()
`;
            const cleanupCode = `
stdout_val = sys.stdout.getvalue()
stderr_val = sys.stdout.getvalue()
`;
            const plotSaver = `
import base64
buf = io.BytesIO()
if plt.get_fignums() and len(plt.gcf().axes) > 0:
    plt.savefig(buf, format='png', bbox_inches='tight')
    buf.seek(0)
    img_str = base64.b64encode(buf.read()).decode('UTF-8')
else:
    img_str = ""
img_str
`;
            try {
                await pyodide.runPythonAsync(setupCode + code + cleanupCode);
                const stdout = pyodide.runPython("stdout_val");
                const stderr = pyodide.runPython("stderr_val");
                const imgB64 = pyodide.runPython(plotSaver);
                return { stdout, stderr, image: imgB64 ? 'data:image/png;base64,' + imgB64 : null };
            } catch (err) {
                return { error: err.message };
            }
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CodeRunner = ({ id, filename, initialCode }) => {
            const [code, setCode] = useState(initialCode);
            const [output, setOutput] = useState("");
            const [imageSrc, setImageSrc] = useState(null);
            const [status, setStatus] = useState("idle");
            const textareaRef = useRef(null);
            const preRef = useRef(null);

            useEffect(() => {
                if (preRef.current) {
                    preRef.current.removeAttribute('data-highlighted');
                    hljs.highlightElement(preRef.current);
                }
            }, [code]);

            const handleRun = async () => {
                setStatus("running");
                setOutput("");
                setImageSrc(null);
                const result = await runPythonCode(code);
                if (result.error) {
                    setStatus("error");
                    setOutput(result.error);
                } else {
                    setStatus("success");
                    setOutput(result.stdout || (result.image ? "" : "Done (no output)"));
                    if (result.image) setImageSrc(result.image);
                }
            };

            const handleScroll = () => {
                if (textareaRef.current && preRef.current) {
                    preRef.current.scrollTop = textareaRef.current.scrollTop;
                    preRef.current.scrollLeft = textareaRef.current.scrollLeft;
                }
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = e.target.selectionStart;
                    const end = e.target.selectionEnd;
                    setCode(code.substring(0, start) + "    " + code.substring(end));
                    setTimeout(() => { e.target.selectionStart = e.target.selectionEnd = start + 4; }, 0);
                }
            };

            return (
                <div className="mb-6">
                    <div className="editor-container">
                        <div className="run-bar">
                            <span className="text-xs font-mono text-gray-500 font-bold">{filename}</span>
                            <button onClick={handleRun} disabled={status === 'running'} className="run-btn">
                                {status === 'running' ? 'Running...' : '‚ñ∂ Run Code'}
                            </button>
                        </div>
                        <div className="editor-wrapper">
                            <textarea
                                ref={textareaRef}
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                onScroll={handleScroll}
                                onKeyDown={handleKeyDown}
                                spellCheck="false"
                            />
                            <pre ref={preRef}><code className="language-python">{code}</code></pre>
                        </div>
                    </div>
                    <div className="output-box">
                        {status === 'idle' && <div className="text-gray-400 italic">Click run to start...</div>}
                        {status === 'running' && <div className="text-blue-500 animate-pulse">Running simulation...</div>}
                        {status === 'error' && <div className="text-red-500 font-bold">Error Traceback:</div>}
                        <div>{output}</div>
                        {imageSrc && <img src={imageSrc} className="output-img" />}
                    </div>
                </div>
            );
        };

        const code01 = `import math

def f(t,y): return y

t, y = 0., 1.
h = 0.001

while t<1.:
    k1  = f(t, y)
    y  += h*k1
    t  += h

y_exact = math.exp(t)
print('Euler method: %.16f, exact: %.16f, diff: %.16f' % \\
(y,y_exact,abs(y-y_exact)))`;

        const code02 = `import math

def f(t,y): return y

t, y = 0., 1.
h = 0.001

while t<1.:
    k1  = f(t, y)
    k2  = f(t+0.5*h, y+0.5*h*k1)
    y  += h*k2
    t  += h

y_exact = math.exp(t)
print('RK2 method: %.16f, exact: %.16f, diff: %.16f' % \\
(y,y_exact,abs(y-y_exact)))`;

        const code03 = `import math

def f(t,y): return y

t, y = 0., 1.
h = 0.001

while t<1.:
    k1  = f(t, y)
    k2  = f(t+0.5*h, y+0.5*h*k1)
    k3  = f(t+0.5*h, y+0.5*h*k2)
    k4  = f(t+h, y+h*k3)
    y  += h/6.*(k1+2.*k2+2.*k3+k4)
    t  += h

y_exact = math.exp(t)
print('RK4 method: %.16f, exact: %.16f, diff: %.16f' % \\
(y,y_exact,abs(y-y_exact)))`;

        const code04 = `import math

def f(t,y): return y

t, y = 0., 1.
h = 0.001
steps = 0

while t<1.:
    while(True):
        k1  = f(t, y)
        k2  = f(t+1./5.*h, y+1./5.*h*k1)
        k3  = f(t+3./10.*h, y+h*(3./40.*k1 + 9./40.*k2))
        k4  = f(t+3./5.*h, y+h*(3./10.*k1 - 9./10.*k2 + 6./5.*k3))
        k5  = f(t+h,y+h*(-11./54.*k1 + 5./2.*k2 - 70./27.*k3 + 35./27.*k4))
        k6  = f(t+7./8.*h,y+h*(1631./55296.*k1 + 175./512.*k2 + 575./13824.*k3 + 44275./110592.*k4 + 253./4096.*k5))
    
        yn = y+h*(37./378.*k1 + 250./621.*k3 + 125./594.*k4 + 512./1771.*k6)
        yp = y+h*(2825./27648.*k1 + 18575./48384.*k3 + 13525./55296.*k4 + 277./14336.*k5 + 1./4.*k6)
        err = max(abs(yn-yp)/1E-14,0.01)
        if err<1.: break
        
        hn = 0.9*h*err**-0.25
        if hn < h*0.1: hn = h*0.1
        h = hn

    y = yn
    t += h
    steps += 1

    hn = 0.9*h*err**-0.2
    if hn > h*5.: hn = h*5.
    h = hn

y_exact = math.exp(t)
print('RK45 method after %d step (t=%.16f): %.16f, exact: %.16f, diff: %.16f' % \\
(steps,t,y,y_exact,abs(y-y_exact)))`;

        const code07 = `import numpy as np
import matplotlib.pyplot as plt
import matplotlib.animation as animation

# Note: Animation output not supported here.
# This code runs the logic but won't show the movie in this block.
# Use local environment for animation.

fig = plt.figure(figsize=(6,6), dpi=80)
ax = plt.axes(xlim=(-1.2,+1.2), ylim=(-1.2,+1.2))

# ... (See file l206-example-07.py for full code)
# We will just print the final energy as a check
m, g, R = 1., 9.8, 1.
t, h = 0., 0.001
y = np.array([np.pi*0.9999,0.])

def f(t,y):     
    theta   = y[0] 
    thetap  = y[1]
    thetapp = -g/R*np.sin(theta)
    return np.array([thetap,thetapp])

for step in range(400): # 400 steps
    k1  = f(t, y)
    y  += h*k1
    t  += h    

theta  = y[0]
thetap = y[1]
E = m*g*-np.cos(theta) + 0.5*m*(R*thetap)**2
print(f"Euler Energy after {t:.3f}s: {E:.4f} (Not conserved!)")`;

        const code08 = `import numpy as np
from scipy.integrate import solve_ivp

m, g, R = 1., 9.8, 1.
t = 0.
y = np.array([np.pi*0.9999,0.])

def f(t,y):     
    theta   = y[0]
    thetap  = y[1]
    thetapp = -g/R*np.sin(theta)
    return np.array([thetap,thetapp])

print("Solving with SciPy RK45...")
while t<2.:
    sol = solve_ivp(f, [t, t+0.1], y)
    y      = sol.y[:,-1]
    t      = sol.t[-1]
    print('At %.2f sec : theta=%+14.10f' % (t, y[0]))`;

        const code08a = `import numpy as np
import matplotlib.pyplot as plt
from scipy.integrate import solve_ivp

# Animation logic using SciPy (See l206-example-08a.py)`;

        const code09 = `import numpy as np
from scipy.integrate import solve_ivp

# Spring Simulation Logic (See l206-example-09.py)
# Visualized in the canvas on the left.
print("Spring code uses VPython in local version.")
print("Here we use Canvas for standard web visualization.")`;

        const code09a = `import numpy as np
from scipy.integrate import solve_ivp

# Double Spring (Coupled)
# See l206-example-09a.py
print("Double Spring code loaded.")`;


        const root = ReactDOM.createRoot(document.getElementById('code-01'));
        root.render(<CodeRunner filename="l206-example-01.py" initialCode={code01} />);

        ReactDOM.createRoot(document.getElementById('code-02')).render(<CodeRunner filename="l206-example-02.py" initialCode={code02} />);
        ReactDOM.createRoot(document.getElementById('code-03')).render(<CodeRunner filename="l206-example-03.py" initialCode={code03} />);
        ReactDOM.createRoot(document.getElementById('code-04')).render(<CodeRunner filename="l206-example-04.py" initialCode={code04} />);
        ReactDOM.createRoot(document.getElementById('code-07')).render(<CodeRunner filename="l206-example-07.py" initialCode={code07} />);

        // For Animation Codes, just show static code or placeholder if it relies on animation lib
        ReactDOM.createRoot(document.getElementById('code-08a')).render(<CodeRunner filename="l206-example-08a.py" initialCode={code08a} />);

        ReactDOM.createRoot(document.getElementById('code-08')).render(<CodeRunner filename="l206-example-08.py" initialCode={code08} />);
        ReactDOM.createRoot(document.getElementById('code-09')).render(<CodeRunner filename="l206-example-09.py" initialCode={code09} />);
        ReactDOM.createRoot(document.getElementById('code-09a')).render(<CodeRunner filename="l206-example-09a.py" initialCode={code09a} />);

        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false }
            ]
        });
    </script>
</body>

</html>