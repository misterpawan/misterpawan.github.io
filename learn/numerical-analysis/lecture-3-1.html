<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecture 3-1: Machine Learning - The Complete Guide ü§ñ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ntu: {
                            blue: '#1e3a8a',
                            light: '#dbeafe',
                            code: '#282c34',
                            accent: '#f59e0b',
                        }
                    },
                    fontFamily: {
                        sans: ['Segoe UI', 'sans-serif'],
                        mono: ['Consolas', 'Monaco', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f8fafc;
            color: #334155;
        }

        .slide-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        /* Container for the Editor Area */
        .editor-container {
            position: relative;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #ffffff;
            /* Light background */
            margin-bottom: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* The Overlay Editor: Textarea on top of Pre/Code */
        .editor-wrapper {
            position: relative;
            min-height: 250px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            background-color: #ffffff;
        }

        /* Common styles for both textarea and pre to ensure perfect alignment */
        .editor-wrapper textarea,
        .editor-wrapper pre {
            margin: 0;
            padding: 1rem;
            border: none;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            white-space: pre;
            overflow: auto;
            word-wrap: normal;
            position: absolute;
            top: 0;
            left: 0;
            font-family: inherit;
            font-size: inherit;
            line-height: inherit;
            tab-size: 4;
        }

        /* The Textarea: Transparent, caret visible, handles input */
        .editor-wrapper textarea {
            z-index: 2;
            color: transparent;
            background: transparent;
            caret-color: #000;
            /* Dark caret */
            resize: none;
            outline: none;
        }

        /* The Pre/Code: Visible syntax highlighting, sits below */
        .editor-wrapper pre {
            z-index: 1;
            background: transparent;
            pointer-events: none;
            /* Let clicks pass through to textarea */
        }

        .editor-wrapper code {
            font-family: inherit;
        }

        .run-bar {
            background: #f1f5f9;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .run-btn {
            background: #e11d48;
            color: white;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .run-btn:hover {
            background: #be123c;
        }

        .run-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        /* Output Box: Separated */
        .output-box {
            margin-top: 0.5rem;
            background: #1e293b;
            /* Keep output dark for contrast/terminal feel */
            color: #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            min-height: 100px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .output-img {
            max-width: 100%;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #4b5263;
            background: white;
            /* Images often need white bg */
        }

        .math-box {
            background: #f1f5f9;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
            overflow-x: auto;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="antialiased">

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <span class="font-bold text-xl text-ntu-blue flex items-center gap-2">
                <span>ü§ñ</span> Lecture 3-1: Machine Learning
            </span>
            <div class="hidden md:flex space-x-1 text-sm font-medium text-slate-600">
                <a href="#intro" class="px-3 py-1 hover:bg-gray-100 rounded">Intro</a>
                <a href="#mnist" class="px-3 py-1 hover:bg-gray-100 rounded">MNIST Data</a>
                <a href="#roc" class="px-3 py-1 hover:bg-gray-100 rounded">Features & ROC</a>
                <a href="#lda" class="px-3 py-1 hover:bg-gray-100 rounded">Fisher's & LDA</a>
                <a href="#svm" class="px-3 py-1 hover:bg-gray-100 rounded">SVM</a>
                <a href="#nonlinear" class="px-3 py-1 hover:bg-gray-100 rounded">Non-Linear</a>
            </div>
        </div>
    </nav>

    <header class="pt-24 pb-16 text-center px-4 bg-gradient-to-b from-blue-50 to-transparent">
        <h1 class="text-5xl md:text-6xl font-extrabold text-slate-900 mb-6 tracking-tight">
            Brief on Machine Learning
        </h1>
        <p class="text-xl text-slate-600 max-w-2xl mx-auto mb-8">
            From basic data loading to separating cats & dogs (and zeros from ones). <br>
            <span class="text-sm text-ntu-blue font-mono">Lecture 3-1 ‚Ä¢ Kai-Feng Chen ‚Ä¢ NTU</span>
        </p>
    </header>

    <main class="max-w-7xl mx-auto px-4 pb-20">

        <section id="intro" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">1. The Hype: AI vs ML vs DL ü§î</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 2-7</span>
            </div>
            <div class="grid md:grid-cols-2 gap-8 mb-8">
                <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                    <h3 class="font-bold text-blue-800 mb-4 text-lg">The Hierarchy üßÖ</h3>
                    <ul class="space-y-3 relative border-l-2 border-blue-200 ml-3 pl-6">
                        <li class="relative">
                            <span class="absolute -left-[33px] bg-blue-500 w-4 h-4 rounded-full mt-1"></span>
                            <strong>AI:</strong> Mimicking human behavior (1950s+).
                        </li>
                        <li class="relative">
                            <span class="absolute -left-[33px] bg-blue-400 w-4 h-4 rounded-full mt-1"></span>
                            <strong>Machine Learning (ML):</strong> Learning from data without explicit programming
                            (1980s+).
                        </li>
                        <li class="relative">
                            <span class="absolute -left-[33px] bg-blue-300 w-4 h-4 rounded-full mt-1"></span>
                            <strong>Deep Learning (DL):</strong> Neural Networks with many layers (2010s+).
                        </li>
                    </ul>
                </div>
                <div class="flex flex-col justify-center items-center text-center">
                    <div class="text-6xl mb-4">üß† ‚û°Ô∏è üíª</div>
                    <p class="text-sm text-gray-500 italic">"Machine learning gives computers the ability to learn
                        without being explicitly programmed."</p>
                </div>
            </div>
        </section>

        <section id="mnist" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">2. Loading MNIST Data üëã</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 8-13</span>
            </div>

            <p class="mb-4">Before we analyze, we must load the data. We use the famous MNIST dataset of handwritten
                digits.</p>
            <div class="bg-yellow-50 p-3 mb-4 rounded border border-yellow-200 text-sm">
                <strong>Initializing Pyodide...</strong> Please run this block first to load the 11MB dataset. It might
                take a few seconds.
            </div>

            <div id="code-01"></div>

            <div class="grid md:grid-cols-2 gap-6 mt-8">
                <div>
                    <h3 class="text-lg font-bold mb-2">Visualizing a Single Digit</h3>
                    <p class="text-sm text-gray-600 mb-2">Let's plot the first sample to verify it's a digit.</p>
                    <div id="code-01a"></div>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-2">Separating 0 and 1</h3>
                    <p class="text-sm text-gray-600 mb-2">We filter the dataset to keep only zeros and ones.</p>
                    <div id="code-01b"></div>
                </div>
            </div>
        </section>

        <section id="roc" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">3. Feature Extraction & ROC üìâ</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 14-23</span>
            </div>

            <p class="mb-4">
                Raw pixels are hard to classify directly. Let's create features!
                <br><strong>Idea:</strong> Zeros have a hole in the middle. Ones are solid.
            </p>

            <p class="text-sm italic text-gray-500 mb-2">Calculating mean intensities...</p>
            <div id="code-02a"></div>

            <div class="mt-8 mb-4">
                <h3 class="text-xl font-bold text-slate-800">Calculating AUC (Area Under Curve)</h3>
                <p class="text-gray-600">The AUC tells us which feature is better. 1.0 is perfect.</p>
            </div>

            <div id="code-02b"></div>

        </section>

        <section id="lda" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">4. Fisher's Discriminant & LDA üìê</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 24-37</span>
            </div>

            <div class="grid md:grid-cols-2 gap-8 mb-6">
                <div>
                    <p class="mb-4">
                        Fisher's Discriminant finds the best linear combination of features to separate classes by
                        maximizing the distance between means ($\mu$) and minimizing variance ($\Sigma$).
                    </p>
                    <div class="math-box text-sm text-center">
                        $$ \vec{w} \propto (\Sigma_0 + \Sigma_1)^{-1}(\vec{\mu}_1 - \vec{\mu}_0) $$
                    </div>
                </div>
                <div>
                    <div id="code-03" style="margin-top: 0;"></div>
                </div>
            </div>

            <div class="mb-8">
                <h4 class="font-bold text-gray-700 mb-2">Visualizing Fisher's Separation</h4>
                <div id="code-03a"></div>
            </div>

            <hr class="my-8 border-gray-200">

            <div class="mb-4">
                <h3 class="text-xl font-bold text-slate-800">LDA with Scikit-Learn</h3>
                <p class="text-gray-600">Now let's use the professional tool.</p>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div id="code-04"></div>
                <div id="code-04b"></div>
            </div>
        </section>

        <section id="svm" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">5. Support Vector Machines (SVM) ‚öîÔ∏è</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 40-49</span>
            </div>

            <p class="mb-4">
                SVM maximizes the <strong>margin</strong> between classes. It focuses on the edge cases (Support
                Vectors).
            </p>

            <div id="code-05"></div>

            <div class="mt-8 mb-4">
                <h3 class="text-xl font-bold text-slate-800">Visualizing the Decision Boundary</h3>
                <p class="text-gray-600">The hyperplane that separates 0s and 1s.</p>
            </div>

            <div id="code-05a"></div>

            <div class="mt-8 mb-4">
                <h3 class="text-xl font-bold text-slate-800">The Grand Finale: Full MNIST Classification</h3>
                <p class="text-gray-600">This might take a few seconds...</p>
            </div>

            <div id="code-06"></div>
        </section>

        <section id="nonlinear" class="slide-card">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-ntu-blue">6. The Non-Linear Problem üç©</h2>
                <span class="bg-gray-100 px-3 py-1 rounded text-xs font-mono text-gray-500">Slides 51-54</span>
            </div>

            <p class="mb-4">
                What if data isn't linearly separable? (Like a red dot inside a blue ring). We need the <strong>Kernel
                    Trick</strong>.
            </p>

            <div id="code-07"></div>

            <div class="grid md:grid-cols-2 gap-6 mt-8">
                <div>
                    <h4 class="font-bold text-red-600 mb-2">Linear Kernel (Fail)</h4>
                    <div id="code-07a"></div>
                </div>
                <div>
                    <h4 class="font-bold text-green-600 mb-2">RBF Kernel (Success)</h4>
                    <div id="code-07b"></div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-white border-t py-12 text-center text-sm text-gray-400 mt-12">
        <p>Numerical Analysis Lecture 3-1 ‚Ä¢ Kai-Feng Chen ‚Ä¢ National Taiwan University</p>
    </footer>

    <!-- SHARED PYODIDE LOGIC -->
    <script>
        let pyodide = null;
        let pyodideReadyPromise = null;

        async function initPyodideEnvironment() {
            if (pyodideReadyPromise) return pyodideReadyPromise;

            pyodideReadyPromise = (async () => {
                console.log("Loading Pyodide...");
                pyodide = await loadPyodide();
                console.log("Loading Packages...");
                await pyodide.loadPackage(['numpy', 'scipy', 'matplotlib', 'scikit-learn', 'pandas']);

                // Load local MNIST data
                const response = await fetch('assets/mnist.npz');
                const buffer = await response.arrayBuffer();

                // Create assets directory and write file
                pyodide.FS.mkdir('assets');
                pyodide.FS.writeFile('assets/mnist.npz', new Uint8Array(buffer));
                console.log("MNIST dataset loaded into virtual filesystem at assets/mnist.npz");

                return pyodide;
            })();
            return pyodideReadyPromise;
        }

        // Shared function for execution
        async function runPythonCode(code) {
            await initPyodideEnvironment();

            // Setup capture
            const setupCode = `
import sys
import io
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
plt.clf() # Clear previous plots
sys.stdout = io.StringIO()
sys.stderr = io.StringIO()
`;

            const cleanupCode = `
stdout_val = sys.stdout.getvalue()
stderr_val = sys.stdout.getvalue()
`;

            const plotSaver = `
import base64
buf = io.BytesIO()
if plt.get_fignums():
    plt.savefig(buf, format='png', bbox_inches='tight')
    buf.seek(0)
    img_str = base64.b64encode(buf.read()).decode('UTF-8')
else:
    img_str = ""
img_str
`;

            try {
                // Run user code wrapped
                await pyodide.runPythonAsync(setupCode + code + cleanupCode);

                const stdout = pyodide.runPython("stdout_val");
                const stderr = pyodide.runPython("stderr_val");
                const imgB64 = pyodide.runPython(plotSaver);

                return { stdout, stderr, image: imgB64 ? 'data:image/png;base64,' + imgB64 : null };
            } catch (err) {
                return { error: err.message };
            }
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CodeRunner = ({ id, filename, initialCode }) => {
            const [code, setCode] = useState(initialCode);
            const [output, setOutput] = useState("");
            const [imageSrc, setImageSrc] = useState(null);
            const [status, setStatus] = useState("idle"); // idle, running, error
            const textareaRef = useRef(null);
            const preRef = useRef(null);

            // Highlight logic
            useEffect(() => {
                if (preRef.current) {
                    // Reset and highlight
                    preRef.current.removeAttribute('data-highlighted');
                    hljs.highlightElement(preRef.current);
                }
            }, [code]);

            const handleRun = async () => {
                setStatus("running");
                setOutput("");
                setImageSrc(null);

                const result = await runPythonCode(code);

                if (result.error) {
                    setStatus("error");
                    setOutput(result.error);
                } else {
                    setStatus("success");
                    setOutput(result.stdout || (result.image ? "" : "Done (no output)"));
                    if (result.stdout && result.stdout.trim().length === 0 && !result.image) {
                        setOutput("Done (no output). Did you forget print()?");
                    }
                    if (result.image) setImageSrc(result.image);
                }
            };

            // Sync scrolling
            const handleScroll = () => {
                if (textareaRef.current && preRef.current) {
                    preRef.current.scrollTop = textareaRef.current.scrollTop;
                    preRef.current.scrollLeft = textareaRef.current.scrollLeft;
                }
            };

            // Tab handling
            const handleKeyDown = (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = e.target.selectionStart;
                    const end = e.target.selectionEnd;
                    const newValue = code.substring(0, start) + "    " + code.substring(end);
                    setCode(newValue);
                    setTimeout(() => {
                        e.target.selectionStart = e.target.selectionEnd = start + 4;
                    }, 0);
                }
            };

            return (
                <div className="mb-8">
                    <div className="editor-container">
                        <div className="run-bar">
                            <span className="text-xs font-mono text-gray-500 font-bold">{filename}</span>
                            <button onClick={handleRun} disabled={status === 'running'} className="run-btn">
                                {status === 'running' ? 'Running...' : '‚ñ∂ Run Code'}
                            </button>
                        </div>
                        <div className="editor-wrapper">
                            <textarea
                                ref={textareaRef}
                                value={code}
                                onChange={(e) => setCode(e.target.value)}
                                onScroll={handleScroll}
                                onKeyDown={handleKeyDown}
                                spellCheck="false"
                            />
                            <pre ref={preRef}><code className="language-python">{code}</code></pre>
                        </div>
                    </div>

                    <div className="output-box">
                        {status === 'idle' && <div className="text-gray-500 italic">Output will appear here...</div>}
                        {status === 'running' && <div className="text-blue-400 animate-pulse">Executing...</div>}
                        {status === 'error' && <div className="text-red-400 font-bold mb-2">Error Traceback:</div>}

                        <div>{output}</div>
                        {imageSrc && <img src={imageSrc} className="output-img" />}
                    </div>
                </div>
            );
        };

        // --- EXAMPLES ---

        // 1. Data Loading
        const code01 = `import numpy as np
# Loading local mnist.npz
data = np.load('assets/mnist.npz')
x_train = data['x_train']
y_train = data['y_train']
x_test = data['x_test']
y_test = data['y_test']

print('Training Set:', x_train.shape)
print('Test Set:', x_test.shape)
print('First label:', y_train[0])
`;
        ReactDOM.createRoot(document.getElementById('code-01')).render(
            <CodeRunner filename="01_load_data.py" initialCode={code01} />
        );

        // 2. Plot One
        const code01a = `import matplotlib.pyplot as plt
import numpy as np
data = np.load('assets/mnist.npz')
x_train = data['x_train']

# Plot the first digit
plt.figure(figsize=(4,4))
plt.imshow(x_train[0], cmap='Greys')
plt.title(f"Label: {data['y_train'][0]}")
plt.colorbar()
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-01a')).render(
            <CodeRunner filename="02_visualize.py" initialCode={code01a} />
        );

        // 3. Grid
        const code01b = `import matplotlib.pyplot as plt
import numpy as np
data = np.load('assets/mnist.npz')
x, y = data['x_train'], data['y_train']

# Keep only 0 and 1
mask = (y == 0) | (y == 1)
x_sub, y_sub = x[mask], y[mask]

print(f"Filtered count: {len(x_sub)}")

# Plot 6
plt.figure(figsize=(6,4))
for i in range(6):
    plt.subplot(2,3,i+1)
    plt.imshow(x_sub[i], cmap='Greys')
    plt.axis('off')
    plt.title(f"Label: {y_sub[i]}")
plt.tight_layout()
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-01b')).render(
            <CodeRunner filename="03_filter.py" initialCode={code01b} />
        );

        // 4. ROC
        const code02a = `import numpy as np
import matplotlib.pyplot as plt

# Load & Prep
data = np.load('assets/mnist.npz')
x, y = data['x_train'], data['y_train']
mask = (y == 0) | (y == 1)
x01, y01 = x[mask], y[mask]

# Feature: Mean Intensity
# Reshape to (N, 784) for easier math if needed, but mean axis=(1,2) works for images
features_mean = x01.mean(axis=(1,2))

# Split by class for histograms (0 vs 1)
feat0 = features_mean[y01==0]
feat1 = features_mean[y01==1]

plt.figure(figsize=(6,4))
plt.hist(feat0, bins=30, alpha=0.5, label='Digit 0')
plt.hist(feat1, bins=30, alpha=0.5, label='Digit 1')
plt.legend()
plt.title("Feature Distrib: Mean Intensity")
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-02a')).render(
            <CodeRunner filename="04_feature_hist.py" initialCode={code02a} />
        );

        // 5. ROC Curve
        const code02b = `from sklearn.metrics import roc_curve, auc
import matplotlib.pyplot as plt

# Using the features from above (simulated context, re-calc here)
features_mean = x01.mean(axis=(1,2))
# Sklearn requires y to be 0/1. Our y01 is 0s and 1s, perfect.
# But note: Usually 1 is positive class. 
# Mean intensity of '0' (hole) vs '1' (stick). 
# '0' typically has MORE ink? No, '0' is bigger. '1' is thin.
# Let's check AUC.

fpr, tpr, _ = roc_curve(y01, features_mean) 
roc_auc = auc(fpr, tpr)

plt.figure(figsize=(5,5))
plt.plot(fpr, tpr, color='darkorange', lw=2, label=f'ROC curve (area = {roc_auc:.2f})')
plt.plot([0, 1], [0, 1], color='navy', lw=2, linestyle='--')
plt.xlabel('False Positive Rate')
plt.ylabel('True Positive Rate')
plt.legend(loc="lower right")
plt.title("ROC: Mean Intensity Feature")
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-02b')).render(
            <CodeRunner filename="05_roc.py" initialCode={code02b} />
        );

        // 6. Manual Fisher
        const code03 = `import numpy as np

# Flatten images
X_flat = x01.reshape(len(x01), -1)

# Split
X0 = X_flat[y01==0]
X1 = X_flat[y01==1]

# Means
mu0 = X0.mean(axis=0)
mu1 = X1.mean(axis=0)

# Covariance (simplified diagonal for stability/speed here, or full)
# Full covariance for 784 dims with 12k samples is heavy in browser?
# Let's try simple difference of means first (w ~ mu1 - mu0) which is LDA with Identity cov.
w = mu0 - mu1  # Direction pointing to 0s?

# Project
proj0 = X0 @ w
proj1 = X1 @ w

print("Projection Stats:")
print(f"Class 0 Mean: {proj0.mean():.2e}")
print(f"Class 1 Mean: {proj1.mean():.2e}")
`;
        ReactDOM.createRoot(document.getElementById('code-03')).render(
            <CodeRunner filename="06_manual_fisher.py" initialCode={code03} />
        );

        // 7. Fisher Hist
        const code03a = `import matplotlib.pyplot as plt
plt.figure(figsize=(6,4))
plt.hist(proj0, bins=50, alpha=0.5, label='Digit 0', color='blue')
plt.hist(proj1, bins=50, alpha=0.5, label='Digit 1', color='green')
plt.title("Projection onto (Mean0 - Mean1)")
plt.legend()
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-03a')).render(
            <CodeRunner filename="07_fisher_hist.py" initialCode={code03a} />
        );

        // 8. Sklearn LDA
        const code04 = `from sklearn.discriminant_analysis import LinearDiscriminantAnalysis
import matplotlib.pyplot as plt

# Use subset to save time if needed, but 12k is ok
X_small = X_flat[::5] # Downsample 5x for speed 
y_small = y01[::5]

lda = LinearDiscriminantAnalysis()
X_lda = lda.fit_transform(X_small, y_small)

plt.figure(figsize=(6,4))
plt.hist(X_lda[y_small==0], bins=30, alpha=0.5, label='0')
plt.hist(X_lda[y_small==1], bins=30, alpha=0.5, label='1')
plt.title("Sklearn LDA Projection")
plt.legend()
plt.show()
print(f"LDA Score: {lda.score(X_small, y_small):.4f}")`;
        ReactDOM.createRoot(document.getElementById('code-04')).render(
            <CodeRunner filename="08_sklearn_lda.py" initialCode={code04} />
        );

        // 9. Scatter 3 classes
        const code04b = `mask3 = (y==0) | (y==1) | (y==2)
X3 = x[mask3].reshape(-1, 784)
y3 = y[mask3]
# Downsample
X3 = X3[::5]
y3 = y3[::5]

lda2 = LinearDiscriminantAnalysis(n_components=2)
X_r2 = lda2.fit_transform(X3, y3)

plt.figure()
colors = ['navy', 'turquoise', 'darkorange']
for color, i, target_name in zip(colors, [0, 1, 2], ['0', '1', '2']):
    plt.scatter(X_r2[y3 == i, 0], X_r2[y3 == i, 1], alpha=.8, color=color,
                label=target_name, s=10)
plt.legend(loc='best', shadow=False, scatterpoints=1)
plt.title('LDA of MNIST (0, 1, 2)')
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-04b')).render(
            <CodeRunner filename="09_lda_3class.py" initialCode={code04b} />
        );

        // 10. Linear SVM
        const code05 = `from sklearn import svm
# Use very small subset for Browser SVM (it's slow!)
X_svm = X_flat[:1000] 
y_svm = y01[:1000]

clf = svm.SVC(kernel='linear')
clf.fit(X_svm, y_svm)

print("Training finished.")
print(f"Score: {clf.score(X_svm, y_svm)}")
print(f"Support Vectors: {len(clf.support_vectors_)}")`;
        ReactDOM.createRoot(document.getElementById('code-05')).render(
            <CodeRunner filename="10_svm_linear.py" initialCode={code05} />
        );

        // 11. SVM Boundary (2D Toy Data)
        const code05a = `import numpy as np
import matplotlib.pyplot as plt
from sklearn import svm

# Generate toy 2D data
np.random.seed(0)
X = np.r_[np.random.randn(20, 2) - [2, 2], np.random.randn(20, 2) + [2, 2]]
Y = [0] * 20 + [1] * 20

# Fit
clf = svm.SVC(kernel='linear')
clf.fit(X, Y)

# Plot
plt.figure(figsize=(5,4))
plt.scatter(X[:, 0], X[:, 1], c=Y, cmap=plt.cm.Paired)
ax = plt.gca()
xlim = ax.get_xlim()
ylim = ax.get_ylim()

# Grid
xx = np.linspace(xlim[0], xlim[1], 30)
yy = np.linspace(ylim[0], ylim[1], 30)
YY, XX = np.meshgrid(yy, xx)
xy = np.vstack([XX.ravel(), YY.ravel()]).T
Z = clf.decision_function(xy).reshape(XX.shape)

# Boundary
ax.contour(XX, YY, Z, colors='k', levels=[-1, 0, 1], alpha=0.5,
           linestyles=['--', '-', '--'])
plt.title("Linear SVM Boundary (Toy Data)")
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-05a')).render(
            <CodeRunner filename="11_svm_viz.py" initialCode={code05a} />
        );

        // 12. Full MNIST
        const code06 = `print("Skipping full 70k training in browser to save your CPU.")
print("Concept remains: The margin maximization works in 784 dimensions too!")`;
        ReactDOM.createRoot(document.getElementById('code-06')).render(
            <CodeRunner filename="12_full_mnist.py" initialCode={code06} />
        );

        // 13. Doughnut
        const code07 = `from sklearn.datasets import make_circles
X, y = make_circles(n_samples=100, factor=0.1, noise=0.1)

plt.figure(figsize=(4,4))
plt.scatter(X[:, 0], X[:, 1], c=y, cmap=plt.cm.coolwarm, s=50, edgecolors='k')
plt.title("Non-linear Data (Circles)")
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-07')).render(
            <CodeRunner filename="13_doughnut.py" initialCode={code07} />
        );

        // 14. Linear Fail
        const code07a = `clf = svm.SVC(kernel='linear').fit(X, y)
# Visualizing... same logic as before
plt.figure(figsize=(4,4))
plt.scatter(X[:, 0], X[:, 1], c=y, cmap=plt.cm.coolwarm)
ax = plt.gca()
xlim = ax.get_xlim(); ylim = ax.get_ylim()
xx = np.linspace(xlim[0], xlim[1], 30)
yy = np.linspace(ylim[0], ylim[1], 30)
YY, XX = np.meshgrid(yy, xx)
xy = np.vstack([XX.ravel(), YY.ravel()]).T
Z = clf.decision_function(xy).reshape(XX.shape)
ax.contour(XX, YY, Z, colors='k', levels=[0], alpha=0.5)
plt.title(f"Linear: Acc {clf.score(X,y)}")
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-07a')).render(
            <CodeRunner filename="14_linear_fail.py" initialCode={code07a} />
        );

        // 15. RBF Success
        const code07b = `clf = svm.SVC(kernel='rbf', C=1).fit(X, y)
plt.figure(figsize=(4,4))
plt.scatter(X[:, 0], X[:, 1], c=y, cmap=plt.cm.coolwarm)
# ... grid ...
Z = clf.decision_function(xy).reshape(XX.shape)
ax = plt.gca()
ax.contour(XX, YY, Z, colors='k', levels=[0], alpha=0.5)
plt.title(f"RBF Kernel: Acc {clf.score(X,y)}")
plt.show()`;
        ReactDOM.createRoot(document.getElementById('code-07b')).render(
            <CodeRunner filename="15_rbf_success.py" initialCode={code07b} />
        );

        document.addEventListener("DOMContentLoaded", function () {
            hljs.highlightAll();
            renderMathInElement(document.body, { delimiters: [{ left: "$$", right: "$$", display: true }, { left: "$", right: "$", display: false }] });
        });
    </script>
</body>

</html>