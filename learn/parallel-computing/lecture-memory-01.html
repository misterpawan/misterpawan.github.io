<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parallel Computing: Memory Hierarchy Simulator</title>

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }

        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <i class="fa-solid fa-network-wired text-indigo-600 text-xl"></i>
                    <span class="font-bold text-xl tracking-tight">Parallel<span
                            class="text-indigo-600">Computing</span></span>
                </div>
                <div class="flex space-x-4">
                    <a href="index.html"
                        class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-indigo-600 transition">← Back to
                        Index</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <div class="bg-white border-b border-gray-200 mb-8">
        <div class="max-w-6xl mx-auto px-4 py-16 text-center">
            <span
                class="inline-block py-1 px-3 rounded-full bg-indigo-100 text-indigo-700 text-sm font-semibold mb-4">Chapter
                2</span>
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight mb-4">
                Memory <span class="gradient-text">Hierarchy</span>
            </h1>
            <p class="mt-4 max-w-2xl mx-auto text-xl text-gray-500">
                Understanding Latency, Caching, and Data Movement in CPUs.
            </p>
        </div>
    </div>

    <!-- React App Container -->
    <div id="root"></div>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 py-12 text-center mt-20">
        <p class="text-sm">Course Module: Parallel Computing • Chapter 2</p>
    </footer>

    <!-- React Code -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICON WRAPPERS (FontAwesome) ---
        const Database = ({ className }) => <i className={`fa-solid fa-database ${className}`}></i>;
        const Cpu = ({ className }) => <i className={`fa-solid fa-microchip ${className}`}></i>;
        const HardDrive = ({ className }) => <i className={`fa-solid fa-hard-drive ${className}`}></i>;
        const Play = ({ className }) => <i className={`fa-solid fa-play ${className}`}></i>;
        const RotateCcw = ({ className }) => <i className={`fa-solid fa-rotate-left ${className}`}></i>;
        const Activity = ({ className }) => <i className={`fa-solid fa-chart-line ${className}`}></i>;
        const Layers = ({ className }) => <i className={`fa-solid fa-layer-group ${className}`}></i>;

        // --- CONFIGURATION ---
        const LATENCIES = {
            CACHE: 2,    // Cycles
            RAM: 50,     // Cycles
            DISK: 1000,  // Cycles
        };

        const SIZES = {
            CACHE: 4,
            RAM: 8,
        };

        const DELAY_MS = 600; // Animation speed

        // --- HELPER COMPONENTS ---

        const MemoryBlock = ({ data, highlight, type }) => {
            const baseStyle = "w-16 h-16 flex items-center justify-center border-2 rounded shadow-sm transition-all duration-500 font-mono text-sm font-bold";

            let colorStyle = "bg-gray-50 border-gray-200 text-gray-400"; // Empty
            if (data) {
                if (type === 'CACHE') colorStyle = "bg-green-100 border-green-500 text-green-800";
                if (type === 'RAM') colorStyle = "bg-blue-100 border-blue-500 text-blue-800";
                if (type === 'DISK') colorStyle = "bg-amber-100 border-amber-500 text-amber-800";
            }

            if (highlight) {
                colorStyle = "bg-yellow-300 border-yellow-600 scale-110 shadow-lg z-10";
            }

            return (
                <div className={`${baseStyle} ${colorStyle}`}>
                    {data || "EMPTY"}
                </div>
            );
        };

        const ArrowDown = ({ active }) => (
            <div className={`flex justify-center my-2 transition-opacity duration-300 ${active ? 'opacity-100' : 'opacity-20'}`}>
                <div className="w-1 h-8 bg-gray-400 rounded"></div>
                <div className="absolute mt-6 w-3 h-3 border-r-2 border-b-2 border-gray-400 rotate-45"></div>
            </div>
        );

        // --- MAIN APPLICATION ---

        function MemorySimulator() {
            // Memory State
            const [cache, setCache] = useState([]);
            const [ram, setRam] = useState([]);
            // Disk is conceptual, we just simulate fetching from it

            // System State
            const [processing, setProcessing] = useState(false);
            const [currentAction, setCurrentAction] = useState('Idle');
            const [activeLevel, setActiveLevel] = useState(null); // 'CACHE', 'RAM', 'DISK'

            // Statistics
            const [stats, setStats] = useState({
                hits: 0,
                misses: 0,
                totalCycles: 0,
                accesses: 0
            });

            const [logs, setLogs] = useState([]);
            const [manualInput, setManualInput] = useState('');

            const logContainerRef = useRef(null);

            // Auto-scroll logs
            useEffect(() => {
                if (logContainerRef.current) {
                    logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight;
                }
            }, [logs]);

            // --- LOGIC ---

            const addLog = (msg) => {
                setLogs(prev => [...prev, `[${new Date().toLocaleTimeString()}] ${msg}`]);
            };

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // The Core Memory Access Function
            const accessMemory = async (address) => {
                if (processing || !address) return;
                setProcessing(true);

                let cycles = 0;
                let foundIn = null;

                // 1. Check L1 Cache
                setCurrentAction(`Checking L1 Cache for ${address}...`);
                setActiveLevel('CACHE');
                await sleep(DELAY_MS);
                cycles += LATENCIES.CACHE;

                if (cache.includes(address)) {
                    foundIn = 'CACHE';
                    setStats(prev => ({ ...prev, hits: prev.hits + 1 }));
                    addLog(`HIT: ${address} found in Cache.`);
                } else {
                    // 2. Check RAM
                    setCurrentAction(`Miss! Checking RAM for ${address}... (+${LATENCIES.RAM} cycles)`);
                    setActiveLevel('RAM');
                    setStats(prev => ({ ...prev, misses: prev.misses + 1 }));
                    await sleep(DELAY_MS);
                    cycles += LATENCIES.RAM;

                    if (ram.includes(address)) {
                        foundIn = 'RAM';
                        addLog(`RAM HIT: ${address} found in RAM. Moving to Cache.`);
                    } else {
                        // 3. Fetch from Disk
                        setCurrentAction(`Miss! Fetching from Disk for ${address}... (+${LATENCIES.DISK} cycles)`);
                        setActiveLevel('DISK');
                        await sleep(DELAY_MS);
                        cycles += LATENCIES.DISK;
                        foundIn = 'DISK';
                        addLog(`DISK: Retrieved ${address}. Loading into RAM & Cache.`);
                    }

                    // Move Data Upwards
                    if (foundIn === 'DISK') {
                        // Move to RAM
                        setRam(prev => {
                            const newRam = [...prev, address];
                            if (newRam.length > SIZES.RAM) {
                                const evicted = newRam.shift(); // FIFO
                                addLog(`RAM Full. Evicting ${evicted}`);
                            }
                            return newRam;
                        });
                        await sleep(DELAY_MS / 2);
                    }

                    // Move to Cache (Happens for both RAM hit and Disk fetch)
                    setCache(prev => {
                        const newCache = [...prev, address];
                        if (newCache.length > SIZES.CACHE) {
                            const evicted = newCache.shift(); // FIFO
                            addLog(`Cache Full. Evicting ${evicted}`);
                        }
                        return newCache;
                    });
                }

                // Finalize
                setStats(prev => ({
                    ...prev,
                    accesses: prev.accesses + 1,
                    totalCycles: prev.totalCycles + cycles
                }));

                setCurrentAction(`Access Complete. Total Latency: ${cycles} cycles.`);
                setActiveLevel(null);
                setProcessing(false);
            };

            // --- SCENARIOS ---

            const runScenario = async (type) => {
                if (processing) return;
                setLogs([]);
                setCache([]);
                setRam([]);
                setStats({ hits: 0, misses: 0, totalCycles: 0, accesses: 0 });

                const trace = [];

                if (type === 'MVM') {
                    // Matrix Vector Multiply: y = A * x (2x2 example)
                    // Access pattern: A00, x0, A01, x1, A10, x0, A11, x1
                    trace.push('A00', 'x0', 'A01', 'x1', 'A10', 'x0', 'A11', 'x1');
                    addLog("Starting Matrix-Vector Multiply (2x2)...");
                } else if (type === 'MMM') {
                    // Matrix Matrix Multiply (2x2)
                    // C00 = A00*B00 + A01*B10
                    trace.push('A00', 'B00', 'A01', 'B10');
                    trace.push('A00', 'B01', 'A01', 'B11'); // C01...
                    addLog("Starting Matrix-Matrix Multiply (Subset)...");
                } else if (type === 'SPMV') {
                    // Sparse Matrix (COO format)
                    // Val[0], Row[0], Col[0] -> fetch x[Col[0]]
                    trace.push('Val_A', 'Row_0', 'Col_2'); // Suppose Col is 2
                    trace.push('x2'); // Indirect access based on previous col
                    trace.push('Val_B', 'Row_0', 'Col_5');
                    trace.push('x5');
                    addLog("Starting Sparse Matrix-Vector (COO)...");
                }

                // Process the queue
                for (let addr of trace) {
                    await accessMemory(addr);
                    await sleep(200); // Small pause between instructions
                }
            };

            // --- RENDER HELPERS ---

            const getHitRatio = () => {
                if (stats.accesses === 0) return "0%";
                return ((stats.hits / stats.accesses) * 100).toFixed(1) + "%";
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans text-gray-800">

                    {/* Header */}
                    <div className="max-w-6xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h1 className="text-3xl font-bold text-indigo-700 flex items-center gap-2">
                                <Cpu className="text-indigo-600" /> Memory Hierarchy Simulator
                            </h1>
                            <p className="text-gray-500 mt-1">Visualize data flow, latency, and caching strategies.</p>
                        </div>
                        <div className="flex gap-2">
                            <button
                                onClick={() => { setCache([]); setRam([]); setStats({ hits: 0, misses: 0, totalCycles: 0, accesses: 0 }); setLogs([]); }}
                                className="flex items-center gap-2 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-semibold transition"
                            >
                                <RotateCcw className="" /> Reset
                            </button>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

                        {/* LEFT COLUMN: VISUALIZATION */}
                        <div className="lg:col-span-2 space-y-2">

                            {/* CPU / STATUS */}
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-indigo-100 mb-4 text-center">
                                <div className="text-sm font-bold text-gray-400 uppercase tracking-wide">CPU Status</div>
                                <div className={`text-lg font-semibold mt-1 ${processing ? 'text-indigo-600 animate-pulse' : 'text-gray-700'}`}>
                                    {processing ? currentAction : "Idle - Waiting for instructions"}
                                </div>
                            </div>

                            {/* MEMORY HIERARCHY */}
                            <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200 relative">

                                {/* L1 CACHE */}
                                <div className={`transition-all duration-300 ${activeLevel === 'CACHE' ? 'scale-[1.02] ring-2 ring-green-400' : ''} p-4 rounded-lg bg-green-50 border border-green-200 mb-2`}>
                                    <div className="flex justify-between mb-2">
                                        <span className="font-bold text-green-800 flex items-center gap-2"><Layers className="" /> L1 Cache (Size: {SIZES.CACHE})</span>
                                        <span className="text-xs bg-green-200 px-2 py-1 rounded text-green-800">Lat: {LATENCIES.CACHE} cycles</span>
                                    </div>
                                    <div className="flex gap-2 min-h-[80px]">
                                        {Array.from({ length: SIZES.CACHE }).map((_, i) => (
                                            <MemoryBlock
                                                key={i}
                                                data={cache[i]}
                                                type="CACHE"
                                                highlight={activeLevel === 'CACHE' && cache[i]}
                                            />
                                        ))}
                                    </div>
                                </div>

                                <ArrowDown active={processing} />

                                {/* RAM */}
                                <div className={`transition-all duration-300 ${activeLevel === 'RAM' ? 'scale-[1.02] ring-2 ring-blue-400' : ''} p-4 rounded-lg bg-blue-50 border border-blue-200 mb-2`}>
                                    <div className="flex justify-between mb-2">
                                        <span className="font-bold text-blue-800 flex items-center gap-2"><Database className="" /> Main Memory (RAM) (Size: {SIZES.RAM})</span>
                                        <span className="text-xs bg-blue-200 px-2 py-1 rounded text-blue-800">Lat: {LATENCIES.RAM} cycles</span>
                                    </div>
                                    <div className="grid grid-cols-4 md:grid-cols-8 gap-2 min-h-[80px]">
                                        {Array.from({ length: SIZES.RAM }).map((_, i) => (
                                            <MemoryBlock
                                                key={i}
                                                data={ram[i]}
                                                type="RAM"
                                                highlight={activeLevel === 'RAM' && ram[i]}
                                            />
                                        ))}
                                    </div>
                                </div>

                                <ArrowDown active={activeLevel === 'DISK'} />

                                {/* DISK */}
                                <div className={`transition-all duration-300 ${activeLevel === 'DISK' ? 'scale-[1.02] ring-2 ring-amber-400' : ''} p-4 rounded-lg bg-amber-50 border border-amber-200`}>
                                    <div className="flex justify-between mb-2">
                                        <span className="font-bold text-amber-800 flex items-center gap-2"><HardDrive className="" /> Disk Storage (Virtual Infinite)</span>
                                        <span className="text-xs bg-amber-200 px-2 py-1 rounded text-amber-800">Lat: {LATENCIES.DISK} cycles</span>
                                    </div>
                                    <div className="h-16 flex items-center justify-center border-2 border-dashed border-amber-300 rounded bg-amber-50/50 text-amber-400 italic">
                                        {activeLevel === 'DISK' ? "Reading Sector..." : "Data stored permanently"}
                                    </div>
                                </div>

                            </div>
                        </div>

                        {/* RIGHT COLUMN: CONTROLS & STATS */}
                        <div className="space-y-6">

                            {/* STATS DASHBOARD */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                                    <Activity className="" /> Statistics
                                </h2>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-gray-50 p-3 rounded border">
                                        <div className="text-xs text-gray-500 uppercase">Hit Ratio</div>
                                        <div className="text-2xl font-bold text-indigo-600">{getHitRatio()}</div>
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded border">
                                        <div className="text-xs text-gray-500 uppercase">Total Latency</div>
                                        <div className="text-2xl font-bold text-indigo-600">{stats.totalCycles} <span className="text-sm text-gray-400">cyc</span></div>
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded border">
                                        <div className="text-xs text-gray-500 uppercase">Hits (L1)</div>
                                        <div className="text-xl font-semibold text-green-600">{stats.hits}</div>
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded border">
                                        <div className="text-xs text-gray-500 uppercase">Misses</div>
                                        <div className="text-xl font-semibold text-red-500">{stats.misses}</div>
                                    </div>
                                </div>
                            </div>

                            {/* CONTROLS */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-lg font-bold text-gray-700 mb-4">Controls</h2>

                                {/* Manual Input */}
                                <div className="flex gap-2 mb-6">
                                    <input
                                        type="text"
                                        value={manualInput}
                                        onChange={(e) => setManualInput(e.target.value)}
                                        placeholder="Addr (e.g. Data1)"
                                        className="flex-1 px-3 py-2 border rounded focus:ring-2 focus:ring-indigo-500 outline-none"
                                        onKeyDown={(e) => e.key === 'Enter' && accessMemory(manualInput)}
                                    />
                                    <button
                                        onClick={() => accessMemory(manualInput)}
                                        disabled={processing || !manualInput}
                                        className="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-50"
                                    >
                                        Fetch
                                    </button>
                                </div>

                                {/* Scenarios */}
                                <div className="space-y-2">
                                    <div className="text-xs font-bold text-gray-400 uppercase">Load Example Scenarios</div>
                                    <button
                                        onClick={() => runScenario('MVM')}
                                        disabled={processing}
                                        className="w-full flex items-center justify-between px-4 py-3 bg-white border border-gray-300 hover:bg-gray-50 hover:border-indigo-300 rounded transition text-left"
                                    >
                                        <span className="font-medium text-sm">Matrix-Vector Mult (MVM)</span>
                                        <Play className="text-gray-400" />
                                    </button>
                                    <button
                                        onClick={() => runScenario('MMM')}
                                        disabled={processing}
                                        className="w-full flex items-center justify-between px-4 py-3 bg-white border border-gray-300 hover:bg-gray-50 hover:border-indigo-300 rounded transition text-left"
                                    >
                                        <span className="font-medium text-sm">Matrix-Matrix Mult (MMM)</span>
                                        <Play className="text-gray-400" />
                                    </button>
                                    <button
                                        onClick={() => runScenario('SPMV')}
                                        disabled={processing}
                                        className="w-full flex items-center justify-between px-4 py-3 bg-white border border-gray-300 hover:bg-gray-50 hover:border-indigo-300 rounded transition text-left"
                                    >
                                        <span className="font-medium text-sm">Sparse Matrix (COO)</span>
                                        <Play className="text-gray-400" />
                                    </button>
                                </div>
                            </div>

                            {/* LOGS */}
                            <div className="bg-gray-900 text-green-400 p-4 rounded-xl shadow-inner h-48 overflow-hidden flex flex-col font-mono text-xs">
                                <div className="font-bold border-b border-gray-700 pb-2 mb-2 flex justify-between">
                                    <span>System Logs</span>
                                    <span className="text-gray-500">tail -f</span>
                                </div>
                                <div ref={logContainerRef} className="overflow-y-auto flex-1 space-y-1">
                                    {logs.length === 0 && <span className="text-gray-600 italic">Waiting for operations...</span>}
                                    {logs.map((log, idx) => (
                                        <div key={idx} className="break-words">{log}</div>
                                    ))}
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MemorySimulator />);
    </script>
</body>

</html>